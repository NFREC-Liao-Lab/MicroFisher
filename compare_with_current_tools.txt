##part 1: pre-process  the sequences from metatranscriptomic and metagenomic dataset
#quality control for the fastq sequences

fastqc rawdata/*.gz -t 20 -o fastqc_rawdata


for i in rawdata/*_R1.fastq.gz; do
   basename=$(basename "$i" _R1.fastq.gz)
   echo $basename
   if [ ! -f cleandata/${basename}_R2_val_2.fq.gz ]; then
     trim_galore -q 25 --phred33 --stringency 3 --length 110 \
               --paired rawdata/${basename}_R1.fastq.gz    rawdata/${basename}_R2.fastq.gz \
               --gzip \
               --cores 24 \
               -o cleandata 
   fi
done


##Part 2: fungal classification using metaphlan and kaiju
#https://github.com/biobakery/biobakery/wiki/metaphlan3
#https://github.com/biobakery/MetaPhlAn/wiki/MetaPhlAn-3.0
for i in cleandata/*_R1_val_1.fq.gz; do
    basename=$(basename  "$i" _R1_val_1.fq.gz)
    echo $basename
    if [ ! -f classification/${basename}_metaphlan.profile.txt ]; then
      metaphlan cleandata/${basename}_R1_val_1.fq.gz,cleandata/${basename}_R2_val_2.fq.gz  \
             --input_type fastq  --bowtie2out classification/${basename}_metaphlan.bowtie2.bz2  \
             --nproc 24 -o classification/${basename}_metaphlan.profile.txt
    fi
done

#https://github.com/bioinformatics-centre/kaiju/blob/master/README.md
for i in cleandata/*_R1_val_1.fq.gz; do
    basename=$(basename  "$i" _R1_val_1.fq.gz)
    echo $basename
    if [ ! -f classification/${basename}_kaiju.out ]; then
      kaiju -t database/kaiju/nodes.dmp -f database/kaiju/fungi/kaiju_db_fungi.fmi \
            -i cleandata/${basename}_R1_val_1.fq.gz -j cleandata/${basename}_R2_val_2.fq.gz  \
            -o classification/${basename}_kaiju.out -z 24
    fi
    
    if [! -f classification/${basename}_kaiju_summary.tsv ]; then
      kaiju2table -t database/kaiju/nodes.dmp \
                -n database/kaiju/names.dmp -r genus \
                -o classification/${basename}_kaiju_summary.tsv classification/${basename}_kaiju.out \
                -l superkingdom,phylum,class,order,family,genus,species
    fi
done



